<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

</style>
<body>
<script src="d3.v3.js"></script>
<script src="jquery-2.1.3.min.js"></script>


<table>
  <tr>
    <td>
      <select id="cluster_sel">
        <option value=1>cluster 1</option>
        <option value=2>cluster 2</option>
        <option value=3>cluster 3</option>
        <option value=4>cluster 4</option>
        <option value=5>cluster 5</option>
      </select>
      <br/>
      <br/>
      Select a Longest Common Substring to highligh<br/>
      Male: &nbsp;&nbsp;&nbsp;&nbsp;<select id="cluster_lcs_male"></select> <br/>
      Female: <select id="cluster_lcs_female"></select>
    </td>
  </tr>
  <tr>
    <td>
      <div id="plot"></div>
    </td>
  </tr>
</table>

<script>
var margin = {top: 20, right: 80, bottom: 30, left: 50},
    width = 960 - margin.left - margin.right,
    height = 300 - margin.top - margin.bottom;

var x = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);

var line = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x(d.index); })
    .y(function(d) { return y(d.value); });

var raw_dict = {};

function AddPlot(cid) {
  var data_path = "data/c" + cid + ".txt";

  var color = d3.scale.category10();
  
  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");
  
  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left");
  
  var svg = d3.select("#plot").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .attr("id", "c" + cid)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      
  d3.text(data_path, function(text) {
    var rows = d3.csv.parseRows(text),
        male = [], 
        female = [],
        raw_male = '',
        raw_female = '',
        data = [];
    for (var i=0, n = rows.length; i<n; i++) {
      var row = rows[i][0],
          v = row.split(" "),
          m = v[0],
          f = v[1];
      raw_male += m;
      raw_female += f;
      male.push({'index':i, 'value':parseInt(m)});
      female.push({'index':i, 'value':parseInt(f)});
    }
    
    raw_dict[cid] = {'male': raw_male, 'female': raw_female};
    data = [{'color':'blue', 'values':male},{'color':'red', 'values':female}];
    
    x.domain([0, n]);
    y.domain([0, 5]);
  
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)
      .append("text")
        .attr("x", width)
        .attr("y", -6)
        .style("text-anchor", "end")
        .text("Time Step");
  
    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis)
      .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text("Affect Rate");

    svg.append("text")
      .attr("class", "title")
      .attr("x", width/2)
      .attr("y", 0 - (margin.top / 2))
      .attr("text-anchor", "middle")
      .text(data_path);
  
    var mline = svg.selectAll(".male")
        .data(data)
      .enter().append("g")
        .attr("class", "male");
  
    mline.append("path")
        .attr("class", "line")
        .attr("d", function(d) { return line(d.values); })
        .style("stroke", function(d) { return d.color; });
        
  });
}

var clusters = [['203','212','217','225'],
                ['204','205','208','209','210','211','214','215','219','224'],
                ['206','207','218','220','222','228','230'],
                ['200','202','213'],
                ['201','221','223','226','227','229']];

var cluster_LCSS = [{'male':['4555555555555555555555555555','5555555555555555555555555554'],
                     'female': []},
                   ];
    
function AddClusterPlot(cidx) {
  var clst = clusters[cidx];
  for (var i=0,n=clst.length;i<n;i++) {
    AddPlot(clst[i]);
  }
}

function AddLCSSOptions(cidx) {
  var lcss_set = cluster_LCSS[cidx];
  $('#cluster_lcs_male').find('option').remove().end()
    .append('<option></option>');
  for (var k in lcss_set) {
    var lcss_data = lcss_set[k];
    for (var i=0,n=lcss_data.length;i<n;i++) {
      $('#cluster_lcs_' + k).append('<option value="'+lcss_data[i]+'">'+lcss_data[i]+'</option>');
    }
  }
}

var select_cid=0;

function highlighLCS() {
  var male_lcs = $( "#cluster_lcs_male option:selected" ).val(),
      female_lcs = $( "#cluster_lcs_female option:selected" ).val();

  d3.selectAll('.line')
      .transition()
      .style('opacity',0.2);

  var couples = clusters[select_cid],
      n = couples.length;

  var data_dict =  {};

  d3.selectAll(".hline").remove();

  for (var i=0;i < n; i++ ) {
    var cid = couples[i],
        data = [],
        raw_data = raw_dict[cid],
        raw_male = raw_data.male,
        raw_female = raw_data.male;

    if (male_lcs && male_lcs.length>0) {
      var raw_select = raw_male,
          start = 0;
      
      while (start >=0) {
        start = raw_male.indexOf(male_lcs, start);
        if (start >=0) {
          var values = [];
          for (var j=0, m=male_lcs.length;j<m;j++) { 
            values.push({'index':j+start, 'value':parseInt(male_lcs[j])});
          }
          data.push({'color':'blue', 'values':values});
          start += 1;
        }
      }
    }
    if (female_lcs && female_lcs.length>0) {
      var raw_select = raw_female,
          start = 0;
      
      while (start >=0) {
        start = raw_male.indexOf(female_lcs, start);
        if (start >=0) {
          var values = [];
          for (var j=0, m=female_lcs.length;j<m;j++) { 
            values.push({'index':j+start, 'value':parseInt(female_lcs[j])});
          }
          data.push({'color':'blue', 'values':values});
          start += 1;
        }
      }
    }
    data_dict[cid] = data;
  }

  for (var i=0;i < n; i++ ) {
    var cid = couples[i],
        svg = d3.select("#c" + cid + " g");

    var hline = svg.selectAll(".hline")
        .data(data_dict[cid])
      .enter().append("g")
        .attr("class", "hline");

    hline.append("path")
        .attr("class", "line")
        .attr("d", function(d) { return line(d.values); })
        .style("stroke", function(d) { return d.color; });
  }
}

$('document').ready(function(){
  AddClusterPlot(0);
  AddLCSSOptions(0);

  $('#cluster_sel').change(function(){
    $( "#cluster_sel option:selected" ).each(function() {
      var sel = parseInt($( this ).val());
      select_cid = sel -1;
      $('#plot').empty();
      AddClusterPlot(select_cid)
    });
  });

  $('#cluster_lcs_male').change(function(){
    highlighLCS();
  });
  $('#cluster_lcs_female').change(function(){
    highlighLCS();
  });
});
</script>
